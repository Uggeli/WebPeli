<!DOCTYPE html>
<html>
<head>
    <title>WebPeli</title>
    <meta charset="UTF-8">
    <style>
        body, html { 
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: monospace;
        }
        
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            image-rendering: pixelated;  /* Keep pixel art crisp */
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        #controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: #0f0;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
        }

        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ff0000;
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="loadingOverlay">
        <div>Loading WebPeli...</div>
        <div id="loadingProgress">0%</div>
    </div>

    <!-- Main canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- Controls help -->
    <div id="controls">
        <div>Controls:</div>
        <div>WASD - Move camera</div>
        <div>QE - Rotate camera</div>
        <div>RF - Zoom in/out</div>
        <div>Mouse drag - Pan camera</div>
        <div>Right mouse drag - Rotate</div>
        <div>Mouse wheel - Zoom</div>
        <div>G - Toggle grid</div>
        <div>I - Toggle info</div>
        <div>D - Toggle debug overlay</div>
    </div>

    <!-- Error display -->
    <div id="errorOverlay" class="error"></div>

    <!-- External dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>

    <!-- Shaders -->
    <script src="shaders/basic.js"></script>

    <!-- Core engine -->
    <script src="rendering/IsometricRenderer.js"></script>
    <script src="Camera.js"></script>
    <script src="NetworkManager.js"></script>
    <script src="Game.js"></script>

    <script>
        // Main initialization
        window.addEventListener('load', () => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const errorOverlay = document.getElementById('errorOverlay');
            const progress = document.getElementById('loadingProgress');

            // Simple resource loader
            const resources = [
                'shaders/basic.js',
                'rendering/IsometricRenderer.js',
                'Camera.js',
                'NetworkManager.js',
                'Game.js'
            ];
            
            let loaded = 0;

            // Show loading progress
            const updateProgress = () => {
                loaded++;
                const percent = Math.round((loaded / resources.length) * 100);
                progress.textContent = `${percent}%`;
            };

            // Initialize game when everything is loaded
            const startGame = () => {
                try {
                    // Fade out loading screen
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);

                    // Start game
                    window.game = new Game('gameCanvas');

                    // Error handler
                    window.onerror = (msg, url, line) => {
                        errorOverlay.textContent = `Error: ${msg} (${url}:${line})`;
                        errorOverlay.style.display = 'block';
                        return false;
                    };
                } catch (error) {
                    console.error('Game initialization failed:', error);
                    errorOverlay.textContent = 'Failed to start game: ' + error.message;
                    errorOverlay.style.display = 'block';
                }
            };

            // Check WebGL2 support
            const canvas = document.getElementById('gameCanvas');
            if (!canvas.getContext('webgl2')) {
                errorOverlay.textContent = 'WebGL2 not supported - please use a modern browser';
                errorOverlay.style.display = 'block';
                loadingOverlay.style.display = 'none';
                return;
            }

            // Load all resources
            Promise.all(resources.map(url => 
                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to load ${url}`);
                        updateProgress();
                        return response.text();
                    })
            ))
            .then(startGame)
            .catch(error => {
                console.error('Resource loading failed:', error);
                errorOverlay.textContent = 'Failed to load resources: ' + error.message;
                errorOverlay.style.display = 'block';
                loadingOverlay.style.display = 'none';
            });
        });
    </script>
</body>
</html>